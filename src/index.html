<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <title>Epic Games Store | Baixe e jogue jogos para PC, mods, DLCs e muito mais - Epic Games</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="format-detection" content="telephone=no">
        <meta name="format-detection" content="date=no">
        <meta name="format-detection" content="address=no">
        <meta charset="UTF-8" />
        <link rel="shortcut icon" href="https://static-assets-prod.epicgames.com/epic-store/static/webpack/../favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="styles.css">
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://static-assets-prod.epicgames.com/epic-store/static/webpack/21.egstore-site.4bdc6582aa0fb78eb5b5.css">
    </head>

    <body onload="isLogged()">
        <div id="login" class="flex flex-column ">
            <div class="content flex flex-column">
                <a href="" class="epicLogo cursor-pointer"></a>
                <input type="email" name="email" id="email" placeholder="E-mail">
                <input type="password" name="password" id="password" placeholder="Senha">
                <small id="messageValidation" class="error" >Senha ou Email estão incorretos!</small>
                <small id="messageMinLength" class="error">Preencha e-mail e senha com pelo menos 3 caracteres!</small>
                <button id="login-button" class="flex align-center justify-center">
                    <div id="loader-login">
                        <div class="loader"></div>
                    </div>
                    Entrar
                </button>
            </div>
        </div>

        <div id="home" class="flex-column">
            <nav class="navigation">
                <div>
                    <a href="" class="epicLogo cursor-pointer"></a>
                    <span>
                        STORE
                        <div class="active"></div>
                    </span>
                    <span>
                        PERGUNTAS FREQUENTES
                        <div class="inactive"></div>
                    </span>
                    <span>
                        AJUDA
                        <div class="inactive"></div>
                    </span>
                    <span>
                        UNREAL ENGINE
                        <div class="inactive"></div>
                    </span>
                </div>
    
                <div>
                    <span>
                        <img src="assets/icons/globe-grid-svgrepo-com.svg" width="17" height="17" alt="globe_icon">
                    </span>
                    <span>
                        <div class="flex">
                            <img src="assets/icons/user-svgrepo-com.svg" width="17" height="17" alt="user_icon">
                            <span id="userEnt">ENTRAR</span> 
                        </div>
                        <div class="inactive"></div>
                    </span>
                    <button class="download">
                        <div>BAIXAR EPIC GAMES</div>
                        <div class="burger-menu"></div>
                    </button>
                </div>            
            </nav>
            <div class="main">
                <div class="fixed-header">
                    <div class="icon-search" id="div-search">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 20" preserveAspectRatio="xMidYMid meet" id="svg-search">
                            <g transform="scale(1 -1) rotate(-45 -11.93502884 -2)" stroke="currentColor" stroke-width="1.65" fill="none" fill-rule="evenodd">
                                <circle cx="7.70710678" cy="7.70710678" r="7"></circle>
                                <path d="M15.2071068 8.62132034h5.6923881" stroke-linecap="square"></path>
                            </g>
                        </svg>
    
                        <input type="text" placeholder="Pesquisar loja" id="input-search" autocomplete="off">
                        <div id="input-background"></div>
    
                        <div id="data-rows">
                            <div id="loader-background">
                                <div class="loader"></div>
                            </div>
                            <div id="data-rows-content"></div>
                        </div>

                    </div>
                    <div class="add-new-game flex centralize">
                        <a class="active" href="">Adicionar Jogo</a>
                        <span class="down-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 5 9">
                                <path stroke="currentColor" d="M1 1l3 3.5L1 8" fill="none" fill-rule="evenodd"></path>
                            </svg>
                        </span>
                    </div>
                    <div class="add-new-user">
                        <a class="active" href="">Adicionar usuário</a>
                    </div>
                </div>
    
                <div class="flex carousel-images">
                    <div class="left cursor-pointer">
                        <picture>
                            <img alt="Play Saints Row on Epic Games Store" id="active-carousel-img" />
                        </picture>
                        <div class="current-carousel-button flex">
                            <h3>O tempo está acabando. Economize até 75% em jogos e complementos durante a Promoção do Evento de Agosto. Acaba em 6 de setembro.</h3>
                            <button>ECONOMIZE AGORA</button>
                        </div>
                        <div class="current-carousel-info"></div>
                    </div>
                    <div class="right" id="carousel-games"></div>
                </div>
                <div class="flex centralize" id="balls"></div>
                <div class="flex align-center justify-between">
                    <h2 class="flex highlight">
                        <a href="">
                            Destaques: Promoção do Evento de Agosto
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 5 9">
                                    <path stroke="currentColor" d="M1 1l3 3.5L1 8" fill="none" fill-rule="evenodd"></path>
                                </svg>
                            </span>
                        </a>
                    </h2>
                    <div class="flex">
                        <button class="arrow-button-rotate">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 5 9">
                                <path stroke="currentColor" d="M1 1l3 3.5L1 8" fill="none" fill-rule="evenodd"></path>
                            </svg>
                        </button>
                        <button class="arrow-button">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 5 9">
                                <path stroke="currentColor" d="M1 1l3 3.5L1 8" fill="none" fill-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
    
                <div class="highlight-images-main flex w-100" id="highlight-images">
                    <div class="highlight-images w-100"></div>
                </div>
            </div>
        </div>
        <div id="show-game" class="flex flex-column w-100">
            <div class="game-edit flex-column"></div>
            <div id="loader-game">
                <div class="loader"></div>
            </div>
            <form class="form-edit-game w-100 flex-column" enctype="multipart/form-data" action="javascript:void(0);" ></form>
            <form class="form-save-game w-100 flex-column" enctype="multipart/form-data" action="javascript:void(0);">
                <h3>Cadastrar jogo</h3>
                <label for="title" class="flex flex-column w-100">
                    Título
                    <input name="title" type="text" placeholder="Título" />
                </label>
                <label for="current_price" class="flex flex-column w-100">
                    Preço
                    <input name="current_price" type="number" placeholder="Preço" />
                </label>
                <label for="url" class="flex flex-column w-100">
                    Imagem
                    <input name="url" type="text" placeholder="Imagem do jogo" />
                </label>
                <label for="discount" class="flex flex-column w-100">
                    Desconto
                    <input name="discount" type="number" placeholder="% do desconto" />
                </label>
                <label for="old_price" class="flex flex-column w-100">
                    Preço antigo
                    <input name="old_price" type="number" placeholder="Valor antigo do jogo" />
                </label>
                <button type="submit">SALVAR</button>
            </form>
            <button class="w-100" id="go-back"><span>VOLTAR</span></button>
            <small id="form-game-error" class="error"></small>
        </div>
        <div id="show-user" class="flex flex-column w-100">
            <div id="loader-user">
                <div class="loader"></div>
            </div>
            <form class="form-save-user w-100 flex-column" action="javascript:void(0);" >
                <h3>Cadastrar usuário</h3>
                <label for="name" class="flex flex-column w-100">
                    Nome
                    <input name="name" type="text" placeholder="Nome" required/>
                </label>
                <label for="email" class="flex flex-column w-100">
                    E-mail
                    <input name="email" type="email" placeholder="E-mail" required/>
                </label>
                <label for="password" class="flex flex-column w-100">
                    Senha
                    <input name="password" type="password" placeholder="Senha" required/>
                </label>
                <label for="password_c" class="flex flex-column w-100">
                    Confirmar senha
                    <input name="password_c" type="password" placeholder="Senha" required/>
                </label>
                <button type="submit" class="w-100">SALVAR</button>
            </form>
            <button class="w-100" id="go-back-user"><span>VOLTAR</span></button>
            <small id="form-user-error" class="error"></small>
        </div>
    </body>

    <script type="module">
        import { get, post, update, remove } from "./js/index.js";
        import { popularGames, games } from "./js/games-data.js";

        const gamesData = games() || [];
        const popularGamesData = popularGames() || [];
        const gamesContainer = document.getElementById("highlight-images");
        const popularGamesContainer = document.getElementById("carousel-games");
        const ballsContainer = document.getElementById("balls");
        const dataRows = document.getElementById("data-rows-content");
        const inputSearch = document.getElementById("input-search");
        const inputBackground = document.getElementById("input-background");
        const svgSearch = document.getElementById("svg-search");
        const loading = document.getElementById("loader-background");
        const loadingLogin = document.getElementById("loader-login");
        const loadingUser = document.getElementById("loader-user");
        const loginButton = document.getElementById("login-button");
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const loginPage = document.getElementById("login");
        const homePage = document.getElementById("home");
        const messageValidation = document.getElementById('messageValidation');
        const messageMinLength = document.getElementById('messageMinLength');
        const activeCarouselImg = document.getElementById('active-carousel-img');
        const messageSizeCharacters = document.getElementById('messageMinLength');
        const gamePage = document.getElementById("show-game");
        const baseUrl = "https://epic-games-clone-wheat.vercel.app";
        const newGame = document.querySelector(".add-new-game");
        const gameEdit = document.querySelector(".game-edit");
        const loadingGame = document.getElementById("loader-game");
        const userPage = document.getElementById("show-user");
        const saveGame = document.querySelector(".form-save-game");
        const editGame = document.querySelector(".form-edit-game");
        const returnToHome = document.getElementById("go-back");
        const returnToHomeUser = document.getElementById("go-back-user");
        const gameErr = document.getElementById("form-game-error");
        const userErr = document.getElementById("form-user-error");
        const formUser = document.querySelector(".form-save-user")
        const newUser = document.querySelector(".add-new-user");
        let userEnt = document.getElementById('userEnt');
        let emailValue;
        let passwordValue;
        let img;
        returnToHome.addEventListener("click", event => goHome());
        returnToHomeUser.addEventListener("click", event => goHome());
        newGame.addEventListener("click", event => addNewGame(event));
        newUser.addEventListener("click", event => addNewUser());
        inputSearch.addEventListener("input", event => search(event.target.value));
        inputSearch.addEventListener("focusin", event => { 
            if (event.target.value.length > 0) search(event.target.value);
        });
        loginButton.addEventListener("click", event => login());
        svgSearch.addEventListener("click", event => {
            inputBackground.classList.add("show"); 
            inputSearch.classList.add("show"); 
        });
        inputBackground.addEventListener("click", event => closeSelect());

        saveGame.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const formData = handleSubmit(e);
            // const imageInput = formData.get("image");
            // if (imageInput.size > 2621440) {
            //     gameErr.innerHTML = "IMAGEM PODE TER NO MÁXIMO 2,5MB"
            //     return;
            // };

            if ( formData.title.length < 3 || formData.url.length < 3 ) return gameErr.innerHTML = "Preencha a url e o titulo com no minimo 3 caracteres"
            if ( formData.current_price.length < 2 || formData.old_price.length < 2 ) return gameErr.innerHTML = "Preencha o Preço e o Preço antigo com no minimo 2 caracteres"
            if ( formData.discount.length < 1) return gameErr.innerHTML = "Preencha o Disconto % com no minimo 1 caractere"

            loadingGame.classList.add("show");   
            try {
                const response = await post(baseUrl + '/games/post', formData, false);
                if (response.info?.type == 'Error') throw new Error();
                loadingGame.classList.remove("show");
                saveGame.reset();
                saveGame.classList.remove("show");
                gamePage.classList.remove("show");
                homePage.classList.add("show");
            } catch (error) {
                console.error(error);
                loadingGame.classList.remove("show");
            }
        });

        editGame.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const formData = handleSubmit(e);
            // const imageInput = formData.get("image");
            // if (imageInput.size > 2621440) {
            //     gameErr.innerHTML = "IMAGEM PODE TER NO MÁXIMO 2,5MB"
            //     return;
            // };
            loadingGame.classList.add("show");
            try {
                const response = await update(baseUrl + '/games/update/' + encodeURI(localStorage.getItem('gameId')), formData, false);
                if (response.info?.type == 'Error') throw new Error();
                editGame.reset();
                loadingGame.classList.remove("show");
                populateGame(response.updatedGame);
                editGame.classList.remove("show");
            } catch (error) {
                console.error(error);
                loadingGame.classList.remove("show");
            }
        });

        formUser.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const data = handleSubmit(e);
            if (data.password !== data.password_c) {
                userErr.innerHTML = "SENHAS NÃO COINCIDEM"
                return;
            };
            loadingUser.classList.add("show");
            try {
                const response = await post(baseUrl + '/users/post', data, false);
                if (response.info?.type == 'Error') throw new Error();
                loadingUser.remove("show");
                formUser.reset();
                editGame.classList.remove("show");
                homePage.classList.add("show");
            } catch (error) {
                userErr.innerHTML = "EMAIL JÁ CADASTRADO"
                loadingUser.classList.remove("show");
            }
        });

        email.addEventListener("input", event => {
            messageValidation.classList.remove('show');
            messageMinLength.classList.remove('show');
            emailValue = event.target.value;
        });
        password.addEventListener("input", event => {
            messageValidation.classList.remove('show');
            messageMinLength.classList.remove('show');
            passwordValue = event.target.value;
        });

        async function login() {

            if (
                !passwordValue || 
                !emailValue || 
                emailValue.length < 3 || 
                passwordValue.length < 3
            ) {
                messageMinLength.classList.add('show');
                return;
            }
            loadingLogin.classList.add("show");

            try {
                const response = await post(baseUrl + "/auth/login", { email: emailValue, password: passwordValue }, false);
                if (response.info?.type == 'Error') throw new Error();
                localStorage.setItem('token', response.token);
                localStorage.setItem('userId', response.user?._id);
                localStorage.setItem('admin', response.user?.admin);
                localStorage.getItem('admin') == 'true' ? newUser.classList.add("show") :  newUser.classList.remove("show");
                localStorage.setItem('email', emailValue);
                let email = localStorage.getItem('email');
                userEnt.innerHTML = email;
                loginPage.classList.remove('show');
                homePage.classList.add('show');
                loadingLogin.classList.remove("show");        
            } catch (error) {
                localStorage.clear();
                console.error(error);
                messageValidation.classList.add('show');
                loadingLogin.classList.remove("show");
            }
        }
        
        async function search(inputValue) {
            dataRows.classList.add("show");
            if( inputValue.length < 3 ){
                dataRows.innerHTML = "<div>Digite pelo menos 3 caracteres...</div>";
                return;
            }
            loading.classList.add("show");

            try {
                const response = await get(baseUrl + '/games/search/' + encodeURI(inputValue));
                if (response.info?.type == 'Error') throw new Error();
                let containers = "";
                response.games?.length != 0 ? 
                    response.games?.forEach((item) => {
                        containers += `<div data-value=${ item._id }> ${ item.title } </div>`;
                    })
                    : containers += `<div> Nenhum item encontrado. </div>`;
                
                dataRows.innerHTML = containers;
                dataRows.childNodes.forEach(element => element.addEventListener("click", function () {
                    const gameId = this.getAttribute('data-value');
                    closeSelect();
                    openGameById(gameId);
                }));

                loading.classList.remove("show");
            } catch (error) {
                loading.classList.remove("show");
                console.error(error);
            }
        }

        async function isLogged() {
            let token = localStorage.getItem('token');
            let email = localStorage.getItem('email');
            if (!token || !email) {
                homePage.classList.remove('show');
                loginPage.classList.add('show');
            } else {
                localStorage.getItem('admin') == 'true' ? newUser.classList.add("show") :  newUser.classList.remove("show");
                try {
                    const user = await get(baseUrl + '/users/find/' + email);
                    user ? homePage.classList.add('show') : loginPage.classList.add('show');
                    if (user.info?.type == 'Error') throw new Error();
                } catch (error) {
                    homePage.classList.remove('show');
                    loginPage.classList.add('show');
                    localStorage.clear();
                }
            }

            let gameContainers = "";
            let popularGamesContainers = "";
            let carouselBalls = "";

            if (token && email) {
                homePage.classList.add('show');
                userEnt.innerHTML = email;

            } else {
                loginPage.classList.add('show');
            }

            gamesData.forEach(game => {
                gameContainers += `
                    <div class="highlight-images w-100">
                        <img alt="${ game.title }" src="${ game.url }">
                        <div class="base-game">JOGO BASE</div>
                        <div class="game-name">${ game.title }</div>
                        <div class="flex">
                            <div class="${ game.discount ? 'discount' : 'none' }">${ game.discount }</div>
                            <div class="price">
                                <span class="${ game.discount ? 'old-price' : 'none' }">R$ ${ game.old_price }</span>
                                <span class="current-price">R$ ${ game.current_price }</span>
                            </div>
                        </div>
                    </div>`
            });

            popularGamesData.forEach((game, index) => {
                carouselBalls += `<div class="balls ${ index == 0 ? 'active' : '' }"></div>`
                popularGamesContainers += `
                    <div class="carousel-games ${ index == 0 ? 'active' : '' }">
                        <img src="${ game.url }" alt="${ game.title }" />
                        <h3>${ game.description }</h3>
                        <div class="games-info">
                            ${ game.title }
                        </div>
                    </div>`
            });
            ballsContainer.innerHTML = carouselBalls;
            gamesContainer.innerHTML = gameContainers;
            popularGamesContainer.innerHTML = popularGamesContainers;
            
            let childrenBalls = Array.from(ballsContainer.children);
            let childrenPopularGames = Array.from(popularGamesContainer.children);
            let index = 0;
            const activeDiv = document.createElement("div");
            activeDiv.classList.add("carousel-progress");

            childrenPopularGames[index].appendChild(activeDiv);
            childrenBalls[index].classList.add('active');
            childrenPopularGames[index].classList.add('active');
            defineCarouselImg(childrenPopularGames[index]);

            const activeInterval = setInterval(() => {
                childrenBalls[index].classList.remove('active');
                childrenPopularGames[index].classList.remove('active');
                index++;
                if (index == popularGamesData.length) { 
                    index = 0;
                    popularGamesContainer.scrollLeft = 1;
                }
                childrenBalls[index].classList.add('active');
                childrenPopularGames[index].classList.add('active');
                childrenPopularGames[index].appendChild(activeDiv);
                defineCarouselImg(childrenPopularGames[index]);
                popularGamesContainer.scrollLeft += (img.offsetWidth + 30);
                
            }, 8000);
        }

        function defineCarouselImg(element) {
            element.childNodes.forEach(item => { 
                if (item.constructor.name == 'HTMLImageElement') {
                    activeCarouselImg.classList.toggle("active");
                    activeCarouselImg.src = item.src;
                    img = item;
                }
            });
        }

        function closeSelect() {
            inputBackground.classList.remove("show"); 
            inputSearch.classList.remove("show"); 
            dataRows.classList.remove("show");
        }

        function goHome() {
            homePage.classList.add("show");
            gamePage.classList.remove("show");
            userPage.classList.remove("show");
        }

        async function openGameById(gameId = "") {
            gameErr.innerHTML = "";
            userErr.innerHTML = "";
            if (!gameId) return;
            localStorage.setItem('gameId', gameId);
            homePage.classList.remove("show");
            gamePage.classList.add("show");
            loadingGame.classList.add("show");
            gameEdit.classList.add("show");
            const { game, path } = await get(baseUrl + '/games/find/' + encodeURI(gameId));
            loadingGame.classList.remove("show");
            if (!game) return;
            populateGame(game, path);
            loadingGame.classList.remove("show");
            saveGame.classList.remove("show");
        }

        function handleSubmit(event) {
            const data = new FormData(event.target);
            const value = Object.fromEntries(data.entries());
            return value;
        }   

        function populateGame(game, path) {
            const date = new Date(game.created);
            const formattedDate = date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear();
            saveGame.classList.remove("show");
            gameEdit.innerHTML = 
                `
                <h3>${ game.title }</h3>
                <img src="${ game.url }" alt="${ game.title }" />
                ${ game.author?.email == localStorage.getItem('email') ? 
                    `<button class="w-100" id="start-edit"><span>EDITAR</span></button>` : ''
                }

                <div class="info">
                    <span>Autor</span> 
                    <span>${ game.author?.name }</span> 
                </div>
                <div class="info">
                    <span>Disponível</span> 
                    <span>${ formattedDate }</span> 
                </div>
                <div class="info">
                    <span>Valor</span> 
                    <span>${ game.current_price ? 'R$'+game.current_price : 'Grátis' }</span> 
                </div>`
            editGame.innerHTML = `
                <h3>Editar jogo</h3>
                <label for="title" class="flex flex-column w-100">
                    Título
                    <input name="title" type="text" value="${ game.title }" placeholder="Título" required/>
                </label>
                <label for="current_price" class="flex flex-column w-100">
                    Preço
                    <input name="current_price" type="number" value="${ game.current_price }" placeholder="Preço" required/>
                </label>
                <label for="url" class="flex flex-column w-100">
                    Imagem
                    <input name="url" type="text" placeholder="Imagem do jogo" value="${ game.url }" required/>
                </label>
                <label for="discount" class="flex flex-column w-100">
                    Desconto
                    <input name="discount"  value="${ game.discount }" type="number" placeholder="% do desconto" required/>
                </label>
                <label for="old_price" class="flex flex-column w-100">
                    Preço antigo
                    <input name="old_price" value="${ game.old_price }" type="number" placeholder="Valor antigo do jogo" required/>
                </label>
                <button type="submit">SALVAR</button>
                <button type="button" id="delete-game" class="delete-button">EXCLUIR</button>
                <small class="confirm-delete">Deseja realmente excluir?
                    <span class="yes-delete cursor-pointer">SIM</span>
                    <span class="no-delete cursor-pointer">NÃO</span>
                </small>
            `;   
            const buttonDeleteGame = document.getElementById("delete-game");
            if (game.author?.email == localStorage.getItem('email')) {
                const startEdit = document.getElementById("start-edit");
                startEdit.addEventListener("click", event => editGame.classList.toggle("show")); 
            }
            const confirmDelete = document.querySelector(".confirm-delete");
            const confirmDeleteYes = document.querySelector(".yes-delete");
            const confirmDeleteNo = document.querySelector(".no-delete");

            buttonDeleteGame.addEventListener("click", event => confirmDelete.classList.toggle("show"));
            confirmDeleteYes.addEventListener("click", event => deleteGame(game._id));
            confirmDeleteNo.addEventListener("click", event => confirmDelete.classList.toggle("show"));
        }

        function addNewGame() {
            homePage.classList.remove("show");
            gameErr.innerHTML = "";
            userErr.innerHTML = "";
            gamePage.classList.add("show");
            saveGame.classList.add("show");
            gameEdit.classList.remove("show");
            editGame.classList.remove("show")
        }

        function addNewUser() {
            homePage.classList.remove("show");
            gameErr.innerHTML = "";
            userErr.innerHTML = "";
            userPage.classList.add("show");
        }

        async function deleteGame(gameId = "") {
            loadingGame.classList.add("show");
            await remove(baseUrl + '/games/remove/' + encodeURI(gameId));
            loadingGame.classList.remove("show");
            goHome();
        }

        window.isLogged = isLogged;
    </script>
</html>